<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Sobras - Shopee Premium</title>
  
  <!-- Fontes Google -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Bibliotecas CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <!-- Bibliotecas JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script type="module" src="firebase-config.js"></script>


</head>
<body>
  <div class="app-container">
  <!-- Sidebar -->
  <div id="sidebar-container"></div>


    
<div id="navbar-container"></div>

    
    <!-- Conte√∫do principal -->
    <div class="main-content">
      <div class="page-title">
        <i class="fas fa-check-circle"></i>
        <h1>Mentoria Ferraretto - Confer√™ncia de Sobras</h1>
      </div>
      
      
      <div id="firebase-error" class="card" style="display: none;">
        <div class="card-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Erro de Conex√£o com o Firebase</h3>
        </div>
        <p id="error-message" style="margin-bottom: 1rem;"></p>
        <button onclick="verificarConexao()" class="btn btn-primary">
          <i class="fas fa-sync-alt"></i> Tentar Reconectar
        </button>
      </div>
      
      <!-- Barra de navega√ß√£o por abas -->
      <div class="tab-bar">
        <button class="tab-btn active" onclick="trocarAba('importar')">
          <i class="fas fa-box-open"></i> Conferir Pedidos
        </button>
        <button class="tab-btn" onclick="trocarAba('historico')">
          <i class="fas fa-history"></i> Hist√≥rico
        </button>
        <button class="tab-btn" onclick="trocarAba('faturamento')">
          <i class="fas fa-cash-register"></i> Faturamento Di√°rio
        </button>
        <button class="tab-btn" onclick="trocarAba('registroFaturamento'); carregarRegistrosFaturamento('listaFaturamentoRegistro', 'filtroMesRegistro')">
          <i class="fas fa-file-alt"></i> Registro de Faturamento
        </button>
        <button class="tab-btn" onclick="trocarAba('controleVendas'); carregarControleVendas()">
          <i class="fas fa-boxes"></i> Controle de Vendas
         </button>
        <button class="tab-btn" onclick="trocarAba('acompanhamento'); carregarAcompanhamento()">
          <i class="fas fa-chart-line"></i> Acompanhamento
        </button> 
      </div>

      <!-- Aba de Importa√ß√£o/Confer√™ncia -->
      <div id="importar" class="tab-content active">
 
      </div>

      <!-- Aba de Metas -->
      <div id="metas" class="tab-content">
          </div>

      

      <!-- Aba de Gr√°ficos -->
      <div id="graficos" class="tab-content">
     
      </div>

      <!-- Aba de Hist√≥rico -->
      <div id="historico" class="tab-content">
    
      </div>
      
      <!-- Aba de Faturamento -->
      <div id="faturamento" class="tab-content">
       
      </div>

      <!-- Aba de Registro de Faturamento -->
      <div id="registroFaturamento" class="tab-content">
       
      </div>

      <!-- Aba de Controle de Vendas -->
      <div id="controleVendas" class="tab-content">
       
      </div>

      <!-- Aba de Acompanhamento -->
      <div id="acompanhamento" class="tab-content">

      </div>
    </div>
  </div>

  <!-- Status de conex√£o -->
  <div id="connectionStatus" class="connection-status offline">
    <div class="status-dot"></div>
    <span>Offline - Trabalhando localmente</span>
  </div>

  <script>
    // =============================================
    // CONFIGURA√á√ÉO INICIAL E VARI√ÅVEIS GLOBAIS
    // =============================================
    
   
    
    // Vari√°veis globais
    let db;
    let metas = {};
    let historico = [];
    let produtos = {};
        let dadosAcompanhamento = [];
    let usuarioLogado = { uid: null, perfil: '' };
    let pedidosProcessados = [];
    let graficoBarras, graficoPizza;
 const tabIds = ['importar','metas','graficos','historico','faturamento','registroFaturamento','controleVendas','acompanhamento'];
    const tabsLoaded = Promise.all(
      tabIds.map(t => fetch(`sobras-tabs/${t}.html`).then(res => res.text()).then(html => {
        const el = document.getElementById(t);
        if (el) el.innerHTML = html;
      }))
    );

    // =============================================
    // INICIALIZA√á√ÉO DO FIREBASE E CONFIGURA√á√ïES
    // =============================================
    
    // Inicializa√ß√£o mais robusta do Firebase
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
        const auth = firebase.auth();

        auth.onAuthStateChanged(async user => {
          if (!user) {
            window.location.href = 'index.html?login=1';
            return;
          }
          usuarioLogado.uid = user.uid;
          try {
            const perfilDoc = await db.collection('usuarios').doc(user.uid).get();
            usuarioLogado.perfil = perfilDoc.exists ? (perfilDoc.data().perfil || '') : '';
          } catch (e) {
            console.error('Erro ao obter perfil do usu√°rio:', e);
          }
          await tabsLoaded;
          window.initTooltips && window.initTooltips();

          await carregarProdutos();
          await carregarMetas();
          carregarHistorico();
          const dataField = document.getElementById('dataFaturamento');
          if (dataField) {
            dataField.value = new Date().toISOString().slice(0,10);
          }

          document.getElementById('filtroSKU').addEventListener('input', filtrarPorSKU);
          document.getElementById('filtroHistorico').addEventListener('input', filtrarHistorico);
          document.getElementById('metaSku').addEventListener('input', atualizarPrecoMinimo);
          document.getElementById('filtroStatus').addEventListener('change', filtrarPorSKU);
          document.getElementById('tipoFiltro').addEventListener('change', filtrarPorSKU);
          document.getElementById('btnLimparFiltros')?.addEventListener('click', limparFiltros);
        });

        // Configura√ß√µes importantes para a conex√£o
        db.settings({
          experimentalForceLongPolling: true
        });

        // Habilita persist√™ncia offline
        firebase.firestore().enablePersistence()
          .catch((err) => {
            if (err.code == 'failed-precondition') {
              console.warn("Persist√™ncia offline n√£o suportada em m√∫ltiplas abas");
            } else if (err.code == 'unimplemented') {
              console.warn("Persist√™ncia offline n√£o dispon√≠vel no navegador");
            }
          });

        // Verifica conex√£o
        verificarConexao();

      } catch (error) {
        console.error("Erro ao inicializar Firebase:", error);
        mostrarErroFirebase(error);
      }
    });

 // Eventos dependentes do carregamento da navbar
    document.addEventListener('navbarLoaded', () => {
      const darkToggle = document.getElementById('darkModeToggle');
      if (darkToggle) {
        darkToggle.addEventListener('click', function() {
          this.classList.toggle('active');
          document.body.classList.toggle('dark-mode');
        });
      }

      const menuToggle = document.querySelector('.menu-toggle');
      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          document.querySelector('.sidebar')?.classList.toggle('active');
        });
      }
    });

    // =============================================
    // FUN√á√ïES DE GERENCIAMENTO DE CONEX√ÉO
    // =============================================
    async function consultarDeepSeek(mensagemUser) {
      try {
        const resposta = await fetch("https://us-central1-matheus-35023.cloudfunctions.net/proxyDeepSeek", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "deepseek-chat",
            messages: [
              { role: "system", content: "Voc√™ √© um analista de sobras de produtos da Shopee." },
              { role: "user", content: mensagemUser }
            ]
          })
        });

        const dados = await resposta.json();
        return dados.choices?.[0]?.message?.content || "‚ùå Sem resposta da IA.";
      } catch (error) {
        console.error("Erro ao consultar DeepSeek:", error);
        return "‚ùå Erro ao se comunicar com o servidor.";
      }
    }

    function verificarConexao() {
      firebase.firestore().enableNetwork()
        .then(() => {
          console.log("Conectado ao Firestore");
          document.getElementById('connectionStatus').className = 'connection-status online';
          document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div> <span>Online</span>';
        })
        .catch((error) => {
          console.error("Erro de conex√£o:", error);
          document.getElementById('connectionStatus').className = 'connection-status offline';
          document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div> <span>Offline - Trabalhando localmente</span>';
        });
    }

    function mostrarErroFirebase(error) {
      const errorBox = document.getElementById('firebase-error');
      const errorMessage = document.getElementById('error-message');
      
      errorMessage.innerHTML = `<strong>${error.message}</strong><br>(C√≥digo: ${error.code})`;
      errorBox.style.display = 'block';
      
      console.error("Erro Firebase:", error);
    }

    function updateConnectionStatus(online) {
      const statusElement = document.getElementById('connectionStatus');
      
      if (online) {
        statusElement.innerHTML = '<div class="status-dot"></div> <span>Online</span>';
        statusElement.className = 'connection-status online';
      } else {
        statusElement.innerHTML = '<div class="status-dot"></div> <span>Offline - Trabalhando localmente</span>';
        statusElement.className = 'connection-status offline';
      }
    }

    // =============================================
    // FUN√á√ïES UTILIT√ÅRIAS
    // =============================================
    
    function mostrarSucesso(mensagem) {
      const alerta = document.getElementById('alertSuccess');
      alerta.querySelector('.alert-content').textContent = mensagem;
      alerta.style.display = 'flex';
      
      setTimeout(() => {
        alerta.style.display = 'none';
      }, 5000);
    }

    function mostrarErro(mensagem) {
      const alerta = document.getElementById('alertError');
      alerta.querySelector('.alert-content').textContent = mensagem;
      alerta.style.display = 'flex';
      
      setTimeout(() => {
        alerta.style.display = 'none';
      }, 5000);
    }

    function toggleLoading(botao, texto) {
      const btnText = botao.querySelector('span') || botao;
      if (botao.classList.contains('loading')) {
        botao.classList.remove('loading');
        btnText.innerHTML = texto;
      } else {
        botao.classList.add('loading');
        btnText.innerHTML = '<div class="loading"></div> Carregando...';
      }
    }

    async function executarComRetry(operacao, maxTentativas = 3, delay = 1000) {
      let tentativas = 0;
      
      while (tentativas < maxTentativas) {
        try {
          return await operacao();
        } catch (error) {
          tentativas++;
          if (tentativas >= maxTentativas) throw error;
          
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2; // Aumenta o delay exponencialmente
        }
      }
    }
    
    function atualizarPrecoMinimo() {
      const sku = document.getElementById('metaSku').value.trim();
      const custo = produtos[sku]; // usa o campo `custo`
          const info = document.getElementById('custoProdutoInfo');
      const metaInput = document.getElementById('metaValor');

      if (!info || !metaInput) return;

      if (custo) {
        const valorFormatado = parseFloat(custo).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        info.textContent = `Custo (usado como meta): R$ ${valorFormatado}`;
        info.style.color = '#06d6a0';

        metaInput.value = parseFloat(custo).toFixed(2); // preencher automaticamente o campo de meta
      } else {
        info.textContent = '';
        metaInput.value = '';
      }
    }
    
    // =============================================
    // FUN√á√ïES DE NAVEGA√á√ÉO E INTERFACE
    // =============================================
    
    function trocarAba(id) {
      // Remove a classe 'active' de todas as abas
      document.querySelectorAll('.tab-content').forEach(aba => aba.classList.remove('active'));
      
      // Remove a classe 'active' de todos os bot√µes de aba
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      // Ativa a aba correspondente, se existir
      const abaSelecionada = document.getElementById(id);
      if (abaSelecionada) {
        abaSelecionada.classList.add('active');
      } else {
        console.warn(`‚ùå Aba com ID '${id}' n√£o encontrada.`);
        return;
      }

      // Ativa o bot√£o correspondente
      const botao = Array.from(document.querySelectorAll('.tab-btn'))
        .find(btn => btn.getAttribute('onclick')?.includes(`trocarAba('${id}')`));
      
      if (botao) {
        botao.classList.add('active');
      } else {
        console.warn(`‚ùå Bot√£o com onclick trocarAba('${id}') n√£o encontrado.`);
      }

      // Atualiza gr√°ficos, se necess√°rio
      if (id === 'graficos') {
        setTimeout(atualizarGraficos, 100);
      }
    }

    // =============================================
    // FUN√á√ïES DE GERENCIAMENTO DE METAS
    // =============================================
    async function carregarProdutos() {
      try {
        let consulta = db.collection("products");
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          consulta = consulta.where('uid', '==', usuarioLogado.uid);
        }
        const snapshot = await consulta.get();
        produtos = {};
        const datalist = document.getElementById('listaSkus');
        if (datalist) datalist.innerHTML = '';

        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.sku) return;
          produtos[data.sku] = data.custo;
          if (datalist) {
            const opt = document.createElement('option');
            const preco = data.custo ? parseFloat(data.custo).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '0.00';
            opt.value = data.sku;
            opt.label = `${data.sku} - R$ ${preco}`;
            datalist.appendChild(opt);
          }
        });
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
      }
    }

    async function carregarMetas() {
      try {
        toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
        
        return await executarComRetry(async () => {
          metas = {};
          // Carrega SKUs e custo dos produtos cadastrados
          let produtosSnapQuery = db.collection("products");
          if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
            produtosSnapQuery = produtosSnapQuery.where('uid', '==', usuarioLogado.uid);
          }
          const produtosSnap = await produtosSnapQuery.get();
          produtosSnap.forEach((doc) => {
            const data = doc.data();
            if (data.sku && data.custo !== undefined) {
              metas[data.sku] = {
                valor: parseFloat(data.custo),
                atualizadoEm: new Date()
              };
            }
          });

          // Sobrep√µe com metas salvas manualmente se existirem
          let metasSnapQuery = db.collection("metasSKU");
          if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
            metasSnapQuery = metasSnapQuery.where('uid', '==', usuarioLogado.uid);
          }
          const metasSnap = await metasSnapQuery.get();
          metasSnap.forEach((doc) => {
            const originalSku = doc.id.replaceAll('__', '/');
            metas[originalSku] = {
              valor: doc.data().valor,
              atualizadoEm: doc.data().atualizadoEm?.toDate() || new Date()
            };
          });
          
          renderizarMetas();
          return true;
        });
      } catch (error) {
        mostrarErroFirebase(`Erro ao carregar metas: ${error.message}`);
        console.error("Erro ao carregar metas:", error);
        return false;
      } finally {
        toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      }
    }

    async function carregarHistorico() {
      try {
        return await executarComRetry(async () => {
          historico = [];
          let histQuery = db.collection("historicoMetas");
          if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
            histQuery = histQuery.where('uid', '==', usuarioLogado.uid);
          }
          const snapshot = await histQuery.orderBy("data", "desc").limit(50).get();          
          snapshot.forEach((doc) => {
            historico.push({
              sku: doc.data().sku,
              acao: doc.data().acao,
              valorAnterior: doc.data().valorAnterior,
              valorNovo: doc.data().valorNovo,
              data: doc.data().data.toDate(),
              usuario: doc.data().usuario || 'Sistema'
            });
          });
          
          renderizarHistorico();
          return true;
        });
      } catch (error) {
        mostrarErroFirebase(`Erro ao carregar hist√≥rico: ${error.message}`);
        console.error("Erro ao carregar hist√≥rico:", error);
        return false;
      }
    }

    async function registrarHistorico(sku, acao, valorAnterior, valorNovo) {
      try {
        await executarComRetry(async () => {
          await db.collection("historicoMetas").add({
            sku: sku,
            acao: acao,
            valorAnterior: valorAnterior,
            valorNovo: valorNovo,
            data: new Date(),
            usuario: "Usu√°rio", // Em um sistema real, pegaria do auth
            uid: usuarioLogado.uid
          });
          
          // Recarregar hist√≥rico ap√≥s adicionar novo registro
          await carregarHistorico();
          return true;
        });
      } catch (error) {
        console.error("Erro ao registrar hist√≥rico:", error);
        throw error;
      }
    }

    function renderizarMetas() {
      const tbody = document.querySelector('#tabelaMetas tbody');
      tbody.innerHTML = '';
      
      if (Object.keys(metas).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma meta cadastrada</td></tr>';
        return;
      }
      
      for (let sku in metas) {
        const meta = metas[sku];
        const precoProduto = produtos[sku];
        const dataFormatada = meta.atualizadoEm ? meta.atualizadoEm.toLocaleDateString('pt-BR') : 'N/A';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${sku}</td>
          <td>${precoProduto ? 'R$ ' + parseFloat(precoProduto).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '-'}</td>
          <td>
            <span class="valorMeta">R$ ${meta.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
            <input class="editInput" type="number" value="${meta.valor}" step="0.01" />
          </td>
          <td>${dataFormatada}</td>
          <td>
            <button onclick="editarMeta(this, '${sku}')" class="btn btn-sm" style="background: rgba(67, 97, 238, 0.1); color: var(--primary);">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="excluirMeta('${sku}', this)" class="btn btn-sm" style="background: rgba(239, 71, 111, 0.1); color: var(--danger);">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderizarHistorico() {
      const lista = document.getElementById('listaHistorico');
      lista.innerHTML = '';
      
      if (historico.length === 0) {
        lista.innerHTML = '<div class="history-item" style="text-align: center;">Nenhum registro hist√≥rico encontrado</div>';
        return;
      }
      
      historico.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        let acaoTexto = '';
        let valorTexto = '';
        
        if (item.acao === 'adicionar') {
          acaoTexto = `<span class="badge badge-success">Adicionado</span>`;
          valorTexto = `Novo valor: R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
        } else if (item.acao === 'editar') {
          acaoTexto = `<span class="badge badge-warning">Editado</span>`;
          valorTexto = `De R$ ${item.valorAnterior?.toFixed(2) || '0.00'} para R$ ${item.valorNovo?.toFixed(2) || '0.00'}`;
        } else if (item.acao === 'remover') {
          acaoTexto = `<span class="badge badge-danger">Removido</span>`;
          valorTexto = `Valor anterior: R$ ${item.valorAnterior?.toFixed(2) || '0.00'}`;
        }
        
        div.innerHTML = `
          <div class="flex justify-between items-start flex-wrap gap-4 p-4 rounded-lg shadow transition hover:shadow-xl border border-gray-200 bg-white">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <strong class="text-blue-800">${item.sku}</strong>
                ${acaoTexto}
              </div>
              <div class="text-sm text-gray-600">${valorTexto}</div>
              <div class="text-sm text-gray-500 mt-1">üë§ Por: ${item.usuario}</div>
            </div>
            <div class="text-sm text-gray-500 text-right">
              <i class="fas fa-clock"></i>
              ${item.data.toLocaleDateString('pt-BR')}<br>${item.data.toLocaleTimeString('pt-BR')}
            </div>
          </div>
        `;
        
        lista.appendChild(div);
      });
    }

    function filtrarHistorico() {
      const filtro = document.getElementById('filtroHistorico').value.toLowerCase();
      const itens = document.querySelectorAll('#listaHistorico .history-item');
      
      itens.forEach(item => {
        const sku = item.querySelector('strong')?.textContent.toLowerCase() || '';
        item.style.display = sku.includes(filtro) ? '' : 'none';
      });
    }

    async function adicionarMeta() {
      const skuInput = document.getElementById('metaSku');
      const valorInput = document.getElementById('metaValor');
      
      const sku = skuInput.value.trim();
      const valor = parseFloat(valorInput.value);
      
      if (!sku) {
        mostrarErro('Por favor, informe o SKU do produto.');
        skuInput.focus();
        return;
      }
      
      if (isNaN(valor) || valor <= 0) {
        mostrarErro('Por favor, informe um valor v√°lido para a meta (maior que zero).');
        valorInput.focus();
        return;
      }
      if (!produtos[sku]) {
        const usarIA = confirm("SKU n√£o cadastrado. Deseja uma sugest√£o de meta via IA?");
        
        if (usarIA) {
            try {
                const categoria = prompt("Informe a categoria do produto:");
                if (categoria === null) return;
                
                const custo = prompt("Informe o custo do produto:");
                if (custo === null) return;
                
                const margem = prompt("Informe a margem esperada (%):");
                if (margem === null) return;
                
                const concorrentes = prompt("Informe o pre√ßo m√©dio dos concorrentes:");
                if (concorrentes === null) return;

                const promptText = `Sugira uma meta de sobra para: ${categoria} | Custo: R$${custo} | Margem: ${margem}% | Concorrentes: ${concorrentes}`;
                
                const resposta = await consultarDeepSeek(promptText);
                const match = resposta.match(/R\$\s*([\d.,]+)/);
                const valorSugerido = match ? parseFloat(match[1].replace('.', '').replace(',', '.')) : null;
                
                if (valorSugerido && !isNaN(valorSugerido)) {
                    valorInput.value = valorSugerido.toFixed(2);
                    mostrarSucesso(`Sugest√£o da IA: R$ ${valorSugerido.toFixed(2)}`);
                } else {
                    mostrarErro("N√£o consegui extrair o valor. Resposta completa: " + resposta);
                }
            } catch (error) {
                mostrarErro(`Erro na consulta: ${error.message}`);
            }
            return;
        }
        }
      try {
        toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
        
        const safeSku = sku.replaceAll('/', '__');
        const metaData = {
          valor: valor,
          atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
          uid: usuarioLogado.uid
        };
        
        await executarComRetry(async () => {
          await db.collection("metasSKU").doc(safeSku).set(metaData);
          return true;
        });
        
        // Atualizar localmente
        metas[sku] = {
          valor: valor,
          atualizadoEm: new Date()
        };
        
        // Registrar no hist√≥rico
        await registrarHistorico(sku, 'adicionar', null, valor);
        
        renderizarMetas();
        
        skuInput.value = '';
        valorInput.value = '';
        document.getElementById('custoProdutoInfo').textContent = '';
        
        mostrarSucesso(`Meta para o SKU ${sku} adicionada com sucesso!`);
        
        // Atualizar gr√°ficos se estiver na aba
        if (document.getElementById('graficos').classList.contains('active')) {
          atualizarGraficos();
        }
      } catch (error) {
        mostrarErro(`Erro ao adicionar meta: ${error.message}`);
        console.error("Erro ao adicionar meta:", error);
      } finally {
        toggleLoading(document.getElementById('btnAdicionarMeta'), '<i class="fas fa-plus"></i> Adicionar Meta');
      }
    }

    async function editarMeta(botao, sku) {
      const tr = botao.closest('tr');
      const span = tr.querySelector('.valorMeta');
      const input = tr.querySelector('.editInput');
      const icon = botao.querySelector('i');
      
      if (input.style.display === 'none') {
        // Iniciar edi√ß√£o
        input.style.display = 'inline-block';
        span.style.display = 'none';
        icon.className = 'fas fa-save';
        input.focus();
      } else {
        // Salvar edi√ß√£o
        const novoValor = parseFloat(input.value);
        
        if (isNaN(novoValor) || novoValor <= 0) {
          mostrarErro('Por favor, informe um valor v√°lido para a meta (maior que zero).');
          input.focus();
          return;
        }
        
        try {
          icon.className = 'fas fa-spinner fa-spin';
          
          const valorAnterior = metas[sku].valor;
          const safeSku = sku.replaceAll('/', '__');
          const metaData = {
            valor: novoValor,
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            uid: usuarioLogado.uid
          };
          
          await executarComRetry(async () => {
            await db.collection("metasSKU").doc(safeSku).set(metaData);
            return true;
          });
          
          // Atualizar localmente
          metas[sku] = {
            valor: novoValor,
            atualizadoEm: new Date()
          };
          
          // Registrar no hist√≥rico
          await registrarHistorico(sku, 'editar', valorAnterior, novoValor);
          
          renderizarMetas();
          mostrarSucesso(`Meta para o SKU ${sku} atualizada com sucesso!`);
          
          // Atualizar gr√°ficos se estiver na aba
          if (document.getElementById('graficos').classList.contains('active')) {
            atualizarGraficos();
          }
        } catch (error) {
          mostrarErro(`Erro ao editar meta: ${error.message}`);
          console.error("Erro ao editar meta:", error);
          // Reverter visualmente
          input.value = metas[sku].valor;
        } finally {
          input.style.display = 'none';
          span.style.display = 'inline-block';
          icon.className = 'fas fa-edit';
        }
      }
    }

    async function excluirMeta(sku, botao) {
      if (!confirm(`Tem certeza que deseja excluir a meta do SKU ${sku}?`)) {
        return;
      }
      
      try {
        const icon = botao.querySelector('i');
        icon.className = 'fas fa-spinner fa-spin';
        
        const valorAnterior = metas[sku].valor;
        const safeSku = sku.replaceAll('/', '__');
        
        await executarComRetry(async () => {
          await db.collection("metasSKU").doc(safeSku).delete();
          return true;
        });
        
        // Remover localmente
        delete metas[sku];
        
        // Registrar no hist√≥rico
        await registrarHistorico(sku, 'remover', valorAnterior, null);
        
        renderizarMetas();
        mostrarSucesso(`Meta para o SKU ${sku} removida com sucesso!`);
        
        // Atualizar gr√°ficos se estiver na aba
        if (document.getElementById('graficos').classList.contains('active')) {
          atualizarGraficos();
        }
      } catch (error) {
        mostrarErro(`Erro ao excluir meta: ${error.message}`);
        console.error("Erro ao excluir meta:", error);
      }
    }

    // =============================================
    // FUN√á√ïES DE PROCESSAMENTO DE PEDIDOS
    // =============================================
    
    function processarPlanilha() {
      const fileInput = document.getElementById('inputExcel');
      const file = fileInput.files[0];
      
      if (!file) {
        mostrarErro('Por favor, selecione um arquivo antes de processar.');
        return;
      }
      
      try {
        toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const pedidos = XLSX.utils.sheet_to_json(sheet);
            
            processarPedidos(pedidos);
          } catch (error) {
            mostrarErro(`Erro ao ler o arquivo: ${error.message}`);
            console.error("Erro ao ler arquivo:", error);
          } finally {
            toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
          }
        };
        
        reader.onerror = function() {
          mostrarErro('Erro ao ler o arquivo. Por favor, tente novamente.');
          toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
        };
        
        reader.readAsArrayBuffer(file);
      } catch (error) {
        mostrarErro(`Erro ao processar o arquivo: ${error.message}`);
        console.error("Erro ao processar arquivo:", error);
        toggleLoading(document.getElementById('btnProcessar'), 'Processar Planilha');
      }
    }

    function processarPedidos(pedidos) {
      const contagem = {};
      pedidos.forEach(p => {
        const id = p['ID do pedido'];
        if (id) contagem[id] = (contagem[id] || 0) + 1;
      });

      const tbody = document.querySelector('#resultado tbody');
      tbody.innerHTML = '';
      let totalSobra = 0, totalPercentual = 0, totalPedidos = 0;
      
      pedidosProcessados = [];

      pedidos.forEach(p => {
        const id = p['ID do pedido'];
        if (!id || contagem[id] > 1) return;

        const sku = p['N√∫mero de refer√™ncia SKU'] || '';
        const status = (p['Status do pedido'] || '').toLowerCase();
        if (!sku || status.includes('cancelado') || status.includes('n√£o pago')) return;

        const subtotal = parseFloat(p['Subtotal do produto']) || 0;
        const reembolso = parseFloat(p['Reembolso Shopee']) || 0;
        const cupom = parseFloat(p['Cupom do vendedor']) || 0;
        const comissao = parseFloat(p['Taxa de comiss√£o']) || 0;
        const servico = parseFloat(p['Taxa de servi√ßo']) || 0;
        const sobra = subtotal + reembolso - cupom - comissao - servico;
        const meta = metas[sku]?.valor || 0;
        const percentual = meta ? ((sobra - meta) / meta) * 100 : 0;
        
        const pedidoData = {
          id, sku, subtotal, reembolso, cupom, comissao, servico, sobra, meta, percentual, status
        };
        
        pedidosProcessados.push(pedidoData);

        const tr = document.createElement('tr');
        
        // Determinar classe CSS baseada no desempenho
        let statusClass = '';
        let statusText = '';
        
        if (meta) {
          if (percentual <= -10) {
            statusClass = 'danger';
            statusText = 'Cr√≠tico';
          } else if (percentual <= -5) {
            statusClass = 'warning';
            statusText = 'Aten√ß√£o';
          } else if (percentual >= 5) {
            statusClass = 'success';
            statusText = 'Bom';
          } else {
            statusClass = 'info';
            statusText = 'Normal';
          }
        } else {
          statusClass = 'secondary';
          statusText = 'Sem meta';
        }

        tr.innerHTML = `
          <td>${id}</td>
          <td>${sku}</td>
          <td>R$ ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td>R$ ${reembolso.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td>R$ ${cupom.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td>R$ ${comissao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td>R$ ${servico.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td><strong>R$ ${sobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong><br><small>Meta: R$ ${meta.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</small></td>
          <td>${percentual.toFixed(2)}%</td>
          <td><span class="badge badge-${statusClass}">${statusText}</span></td>
        `;
        
        tbody.appendChild(tr);

        totalSobra += sobra;
        totalPercentual += percentual;
        totalPedidos++;
      });

      // Calcular total esperado com base na quantidade de pedidos por SKU
      const linhas = document.querySelectorAll("#resultado tbody tr");
      let esperadoTotal = 0;
      linhas.forEach(l => {
        const sku = l.children[1].textContent.trim();
        if (metas[sku]) esperadoTotal += metas[sku].valor;
      });
    
      const media = totalPedidos ? (totalPercentual / totalPedidos).toFixed(2) : '0.00';
      const diferencaTotal = totalSobra - esperadoTotal;
      const diferencaPercentual = esperadoTotal ? (diferencaTotal / esperadoTotal) * 100 : 0;

      let diferencaHTML = '';
      if (esperadoTotal > 0) {
        const diferencaClass = diferencaTotal >= 0 ? 'success' : 'danger';
        diferencaHTML = `
          <div style="margin-top: 1rem; padding: 1rem; background: rgba(6, 214, 160, 0.05); border-radius: 12px; border-left: 4px solid var(--${diferencaClass});">
            <h4>
              <span class="badge badge-${diferencaClass}">
                Diferen√ßa Total: R$ ${Math.abs(diferencaTotal).toLocaleString('pt-BR', { minimumFractionDigits: 2 })} 
                (${diferencaPercentual.toFixed(2)}%)
                ${diferencaTotal >= 0 ? 'acima' : 'abaixo'} da meta
              </span>
            </h4>
          </div>
        `;
      }

      document.getElementById('totalSobra').innerHTML = `
        <div class="card">
          <div class="card-header">
            <i class="fas fa-coins"></i>
            <h3>Resumo Financeiro</h3>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div style="background: rgba(67, 97, 238, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--primary);">
              <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Sobra Total</h4>
              <h2>R$ ${totalSobra.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h2>
            </div>
            
            <div style="background: rgba(6, 214, 160, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success);">
              <h4 style="color: var(--success); margin-bottom: 0.5rem;">Sobra Esperada</h4>
              <h2>R$ ${esperadoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h2>
            </div>
            
            <div style="background: rgba(108, 117, 125, 0.05); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--secondary);">
              <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">M√©dia de Desempenho</h4>
              <h2>${media}%</h2>
            </div>
          </div>
          ${diferencaHTML}
        </div>
      `;
        document.getElementById('totalSobra').innerHTML += `
        <div style="margin-top: 1.5rem;">
           
        </div>
    `;
    
    // Salvar dados para an√°lise posterior
    window.dadosParaAnalise = {
        pedidos: pedidosProcessados,
        resumo: {
            totalSobra,
            esperadoTotal,
            media
        }
    };
      const sobras = pedidosProcessados.map(p => {
  return {
    sku: p.sku,
    vendido: p.subtotal,
    sobra: p.sobra,
    meta: p.meta,
    data: new Date().toLocaleDateString()
  };
});

document.getElementById("dadosSobrasIA").value = sobras.map(s => {
  return `SKU: ${s.sku}, Vendido: R$ ${s.vendido.toFixed(2)}, Sobra: R$ ${s.sobra.toFixed(2)}, Meta: R$ ${s.meta?.toFixed(2) || 0}, Data: ${s.data}`;
}).join("\n");
}

      // Atualizar gr√°ficos se estiver na aba
      if (document.getElementById('graficos').classList.contains('active')) {
        atualizarGraficos();
      }
    
    async function analisarSobrasComIA() {
        const btn = document.getElementById('btnAnalisarIA');
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
            btn.disabled = true;

            // Preparar prompt com dados resumidos
    const prompt = `### ANALISAR DESEMPENHO DE SKUs SHOPEE

Abaixo est√£o os dados de performance de estoque da Shopee:
${JSON.stringify(window.dadosParaAnalise, null, 2)}

Quero que voc√™ atue como um analista profissional de vendas.

**Objetivo:** Gerar um relat√≥rio claro, estruturado e com apar√™ncia profissional para orientar decis√µes de estoque e promo√ß√£o.

**Regras de resposta:**
- Use **t√≠tulos e subt√≠tulos claros** em Markdown.
- Agrupe os SKUs em 3 se√ß√µes: 
  1. SKUs com Alta Performance
  2. SKUs Pr√≥ximos √† Meta
  3. SKUs com Baixa Performance
- D√™ **a√ß√µes sugeridas** para cada grupo.
- Crie um bloco final com **Resumo das A√ß√µes Recomendadas**.
- Ao final, inclua a **data da an√°lise** e um rodap√© como "*Relat√≥rio gerado automaticamente por IA de Estoque Shopee*".

**Exemplo de estilo desejado:**

### üìà An√°lise de Performance de SKUs - Shopee  
**üìÖ Data:** [coloque data aqui]

#### ‚úÖ 1. SKUs com Alta Performance
- SKU123: descri√ß√£o...
- A√ß√µes: ...

#### üü° 2. SKUs Pr√≥ximos √† Meta
- SKU456: descri√ß√£o...
- A√ß√µes: ...

#### üî¥ 3. SKUs com Baixa Performance
- SKU789: descri√ß√£o...
- A√ß√µes: ...

#### üß† Resumo de A√ß√µes Priorit√°rias
1. A√ß√£o 1...
2. A√ß√£o 2...

**Pr√≥xima revis√£o sugerida:** daqui a 7 dias

---

Gere a resposta nesse formato. Seja objetivo, mas estrat√©gico.`;

            const resposta = await consultarDeepSeek(prompt);
            
            // Exibir resultado
            document.getElementById('totalSobra').innerHTML += `
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <i class="fas fa-robot"></i>
          <h3>An√°lise Preditiva de Estoque</h3>
        </div>
        <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 0 0 12px 12px;">
          ${resposta}
        </div>
      </div>
    `;
        } catch (error) {
            mostrarErro(`Erro na an√°lise: ${error.message}`);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    
    function limparFiltros() {
      document.getElementById("filtroSKU").value = "";
      document.getElementById("filtroStatus").value = "";
      document.getElementById("tipoFiltro").value = "exata";
      filtrarPorSKU();
    }

    // =============================================
    // FUN√á√ïES DE GR√ÅFICOS
    // =============================================
    
    function atualizarGraficos() {
        // Elemento do cabe√ßalho
        const chartHeader = document.querySelector('.chart-header');
        
        // Limpa o conte√∫do anterior
        chartHeader.innerHTML = '<div class="chart-title">Compara√ß√£o entre Sobra Real e Meta por SKU</div>';
        
        // Verifica√ß√£o de dados
        if (pedidosProcessados.length === 0) {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">Nenhum dado dispon√≠vel para exibir gr√°ficos. Processe um arquivo primeiro.</p>';
            });
            
            // Adiciona bot√£o mesmo sem dados (opcional)
            chartHeader.innerHTML += `
                <button onclick="analisarTendenciasIA()" class="btn btn-outline" disabled>
                    <i class="fas fa-chart-line"></i> Analisar Tend√™ncias com IA
                </button>
            `;
            return;
        }
        
        // Adiciona bot√£o funcional quando h√° dados
        chartHeader.innerHTML += `
            <button onclick="analisarTendenciasIA()" class="btn btn-outline">
                <i class="fas fa-chart-line"></i> Analisar Tend√™ncias com IA
            </button>
        `;
        
        // Processamento dos dados
        const tipoFiltro = document.getElementById('filtroGrafico').value;
        let dados = agruparPorSKU(pedidosProcessados);
        
        // Aplicar filtro
        if (tipoFiltro === 'top10') {
            dados.sort((a, b) => b.diferencaPercentual - a.diferencaPercentual);
            dados = dados.slice(0, 10);
        } else if (tipoFiltro === 'bottom10') {
            dados.sort((a, b) => a.diferencaPercentual - b.diferencaPercentual);
            dados = dados.slice(0, 10);
        }
        
        // Criar gr√°ficos
        criarGraficoBarras(dados);
        criarGraficoPizza(dados);
    }

    function agruparPorSKU(pedidos) {
      const agrupados = {};
      
      pedidos.forEach(pedido => {
        if (!agrupados[pedido.sku]) {
          agrupados[pedido.sku] = {
            sku: pedido.sku,
            totalSobra: 0,
            totalMeta: 0,
            quantidade: 0
          };
        }
        
        agrupados[pedido.sku].totalSobra += pedido.sobra;
        agrupados[pedido.sku].totalMeta += pedido.meta || 0;
        agrupados[pedido.sku].quantidade += 1;
      });
      
      // Converter para array e calcular diferen√ßas
      return Object.values(agrupados).map(item => {
        const diferenca = item.totalSobra - item.totalMeta;
        const diferencaPercentual = item.totalMeta ? (diferenca / item.totalMeta) * 100 : 0;
        
        return {
          ...item,
          diferenca,
          diferencaPercentual
        };
      });
    } // ‚Üê Fechamento correto da fun√ß√£o
    async function analisarTendenciasIA() {
        try {
            const prompt = `Analise estes dados de desempenho de produtos:
    ${JSON.stringify(pedidosProcessados.slice(0, 50), null, 2)}

    Identifique:
    1. Tend√™ncias sazonais
    2. Produtos com crescimento/decl√≠nio consistente
    3. Sugest√µes de ajuste de estoque
    4. Previs√£o para pr√≥xima semana

    Responda em t√≥picos curtos e diretos.`;

            const resposta = await consultarDeepSeek(prompt);
            
            // Exibir resultado
            document.querySelector('.chart-header').innerHTML += `
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <i class="fas fa-lightbulb"></i>
                        <h3>An√°lise de Tend√™ncias</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <pre style="white-space: pre-wrap;">${resposta}</pre>
                    </div>
                </div>
            `;
        } catch (error) {
            mostrarErro(`Erro na an√°lise de tend√™ncias: ${error.message}`);
        }
    }
    function criarGraficoBarras(dados) {
      const ctx = document.getElementById('graficoBarras').getContext('2d');
      
      // Destruir gr√°fico anterior se existir
      if (graficoBarras) {
        graficoBarras.destroy();
      }
      
      // Preparar dados
      const labels = dados.map(item => item.sku);
      const sobras = dados.map(item => item.totalSobra);
      const metas = dados.map(item => item.totalMeta);
      
      graficoBarras = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Sobra Real (R$)',
              data: sobras,
              backgroundColor: 'rgba(244, 92, 0, 0.7)',
              borderColor: 'rgba(244, 92, 0, 1)',
              borderWidth: 1
            },
            {
              label: 'Meta Esperada (R$)',
              data: metas,
              backgroundColor: 'rgba(76, 175, 80, 0.7)',
              borderColor: 'rgba(76, 175, 80, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Valor (R$)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'SKU'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Compara√ß√£o entre Sobra Real e Meta por SKU'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += 'R$ ' + context.raw.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                  return label;
                }
              }
            }
          }
        }
      });
    }

    function criarGraficoPizza(dados) {
      const ctx = document.getElementById('graficoPizza').getContext('2d');
      
      // Destruir gr√°fico anterior se existir
      if (graficoPizza) {
        graficoPizza.destroy();
      }
      
      // Preparar dados - vamos mostrar a diferen√ßa percentual
      const labels = dados.map(item => item.sku);
      const diferencas = dados.map(item => item.diferencaPercentual);
      
      // Criar cores baseadas no desempenho
      const backgroundColors = diferencas.map(val => {
        if (val >= 5) return 'rgba(76, 175, 80, 0.7)'; // Verde - acima
        if (val <= -5) return 'rgba(244, 67, 54, 0.7)'; // Vermelho - abaixo
        return 'rgba(255, 193, 7, 0.7)'; // Amarelo - dentro do esperado
      });
      
      graficoPizza = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: diferencas,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Desempenho vs Meta por SKU (%)'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  return `${label}: ${value.toFixed(2)}%`;
                }
              }
            }
          }
        }
      });
    }
    window.importarFaturamento = async function () {
      const input = document.getElementById("inputFaturamento");
      const file = input.files[0];
      if (!file) return mostrarErro("Selecione um arquivo para importar.");

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

const dataInput = document.getElementById("dataFaturamento");
          const lojaInput = document.getElementById("lojaFaturamento");
          const dataReferencia = dataInput?.value;
          const loja = lojaInput?.value?.trim();
          if (!dataReferencia || !/^\d{4}-\d{2}-\d{2}$/.test(dataReferencia)) {
            return mostrarErro("Data inv√°lida.");
          }

          if (!loja || loja.length < 2) {
            return mostrarErro("Nome da loja inv√°lido.");
          }

          const ref = db.collection("faturamento").doc(dataReferencia).collection("lojas").doc(loja);
          const doc = await ref.get();

          let operacao = "salvar";
          if (doc.exists) {
            operacao = confirm("J√° existe um registro para esse dia. Deseja somar ao existente?") ? "somar" : "substituir";
          }

          let bruto = 0, taxas = 0, qtdVendas = 0;

          rows.forEach((row) => {
            const status = (row["Status do pedido"] || "").toLowerCase();
            if (status.includes("cancelado") || status.includes("n√£o pago")) return;

            const subtotal = parseFloat(row["Subtotal do produto"]) || 0;
            const reembolso = parseFloat(row["Reembolso Shopee"]) || 0;
            const cupom = parseFloat(row["Cupom do vendedor"]) || 0;
            const comissao = parseFloat(row["Taxa de comiss√£o"]) || 0;
            const servico = parseFloat(row["Taxa de servi√ßo"]) || 0;

            bruto += subtotal + reembolso;
            taxas += cupom + comissao + servico;
            qtdVendas++;
          });

          const liquido = bruto - taxas;

          if (operacao === "somar" && doc.exists) {
            const anterior = doc.data();
            bruto += anterior.valorBruto || 0;
            taxas += anterior.taxasPlataforma || 0;
            qtdVendas += anterior.qtdVendas || 0;
          }

          // ‚úÖ Agrupar SKUs vendidos usando apenas a coluna exata
          const skusVendidos = {};
          rows.forEach((row) => {
            const status = (row["Status do pedido"] || "").toLowerCase();
            if (status.includes("cancelado") || status.includes("n√£o pago")) return;

            const headers = Object.keys(row);
            const headerSKU = headers.find(h => h.trim() === "N√∫mero de refer√™ncia SKU"); // pega o nome exato

            const sku = headerSKU ? row[headerSKU] : null;
            if (!sku) return;

            if (!skusVendidos[sku]) skusVendidos[sku] = 0;
            skusVendidos[sku]++;
          });

          // Salvar SKUs vendidos
          const refSku = db.collection("skusVendidos").doc(dataReferencia);
          await refSku.set({ data: dataReferencia, uid: usuarioLogado.uid }, { merge: true }); // garante doc pai e marca usu√°rio

          for (const [sku, total] of Object.entries(skusVendidos)) {
            const skuId = String(sku).replace(/[.#$/\[\]]/g, "_");
            const docRef = db.collection("skusVendidos").doc(dataReferencia).collection("lista").doc(skuId);
            const docSnap = await docRef.get();

            let totalFinal = total;
            if (docSnap.exists) {
              const dadosAnteriores = docSnap.data();
              totalFinal += dadosAnteriores.total || 0;
            }

            await docRef.set({
              sku: sku,
              total: totalFinal,
              data: dataReferencia,
              loja: loja,
              uid: usuarioLogado.uid
            });
          }

 const { encryptString } = await import('./crypto.js');
          const pass = getPassphrase() || usuarioLogado.uid;

          const lojaPayload = {
            valorBruto: bruto,
            taxasPlataforma: taxas,
            valorLiquido: liquido,
            qtdVendas: qtdVendas,
            loja: loja,
            atualizadoEm: new Date(),
            uid: usuarioLogado.uid
         };
          const encLoja = await encryptString(JSON.stringify(lojaPayload), pass);
          await ref.set({ encrypted: encLoja, uid: usuarioLogado.uid });

          const resumoPayload = {
            valorBruto: bruto,
            valorLiquido: liquido,
            taxasPlataforma: taxas,
            vendas: qtdVendas,
            atualizadoEm: new Date(),
            uid: usuarioLogado.uid
        };
          const encResumo = await encryptString(JSON.stringify(resumoPayload), pass);
          await db.collection("faturamento").doc(dataReferencia).set({ encrypted: encResumo, uid: usuarioLogado.uid }, { merge: true });

          document.getElementById("resultadoFaturamento").innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i>
              Faturamento de <strong>${dataReferencia}</strong> da loja <strong>${loja}</strong> registrado com sucesso.<br>
              <strong>Bruto:</strong> R$ ${bruto.toFixed(2)}<br>
              <strong>Taxas:</strong> R$ ${taxas.toFixed(2)}<br>
              <strong>L√≠quido:</strong> R$ ${liquido.toFixed(2)}<br>
              <strong>Qtd. Vendas:</strong> ${qtdVendas}
            </div>
          `;

        } catch (err) {
          mostrarErro("Erro ao importar: " + err.message);
          console.error(err);
        }
      };

      reader.readAsArrayBuffer(file);
    };

    // =============================================
    // FUN√á√ïES DE EXPORTA√á√ÉO
    // =============================================
    
    function exportarCSV() {
      if (pedidosProcessados.length === 0) {
        mostrarErro('Nenhum dado dispon√≠vel para exportar. Processe um arquivo primeiro.');
        return;
      }
      
      try {
        // Cabe√ßalhos
        let csv = 'ID do Pedido;SKU;Subtotal;Reembolso;Cupom;Comiss√£o;Servi√ßo;Sobra;Meta;% vs Meta;Status\n';
        
        // Dados
        pedidosProcessados.forEach(pedido => {
          const status = pedido.meta ? 
            (pedido.percentual <= -10 ? 'Cr√≠tico' : 
             pedido.percentual <= -5 ? 'Aten√ß√£o' : 
             pedido.percentual >= 5 ? 'Bom' : 'Normal') : 'Sem meta';
          
          csv += `"${pedido.id}";"${pedido.sku}";"${pedido.subtotal.toFixed(2)}";"${pedido.reembolso.toFixed(2)}";"${pedido.cupom.toFixed(2)}";"${pedido.comissao.toFixed(2)}";"${pedido.servico.toFixed(2)}";"${pedido.sobra.toFixed(2)}";"${pedido.meta.toFixed(2)}";"${pedido.percentual.toFixed(2)}";"${status}"\n`;
        });
        
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.csv`);
        
        mostrarSucesso('Arquivo CSV exportado com sucesso!');
      } catch (error) {
        mostrarErro(`Erro ao exportar CSV: ${error.message}`);
        console.error("Erro ao exportar CSV:", error);
      }
    }
    async function carregarRegistrosFaturamento(idContainer = "listaFaturamento", idFiltroMes = "filtroMes") {
 let ref = db.collection("faturamento");
      if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
        ref = ref.where('uid', '==', usuarioLogado.uid);
      }
      const snap = await ref.get();
      const container = document.getElementById(idContainer);
      container.innerHTML = "";

      const filtroMes = document.getElementById(idFiltroMes)?.value;

      for (const docData of snap.docs) {
        if (filtroMes) {
          const [anoFiltro, mesFiltro] = filtroMes.split("-");
          const [anoData, mesData] = docData.id.split("-");
          if (anoFiltro !== anoData || mesFiltro !== mesData) continue;
        }

 let subRef = db.collection(`faturamento/${docData.id}/lojas`);
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          subRef = subRef.where('uid', '==', usuarioLogado.uid);
        }
        const subSnap = await subRef.get();
                const { decryptString } = await import('./crypto.js');
        let bruto = 0, liquido = 0, qtd = 0;

        for (const sub of subSnap.docs) {
          const dataSub = sub.data();
          let d = dataSub;
          if (dataSub.encrypted) {
            try {
              const txt = await decryptString(dataSub.encrypted, getPassphrase() || usuarioLogado.uid);
              d = JSON.parse(txt);
            } catch (e) { console.error('Erro ao descriptografar faturamento', e); }
          }
          bruto += d.valorBruto || 0;
          liquido += d.valorLiquido || 0;
          qtd += d.qtdVendas || 0;
        }

        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow-lg p-4 border border-gray-200 hover:shadow-xl transition";

        card.innerHTML = `
          <div class="text-sm text-gray-500 mb-2 flex items-center gap-2">
            <i class="fas fa-calendar-alt text-blue-600"></i>
            <span class="font-semibold">${docData.id}</span>
          </div>

          <div class="text-2xl font-bold text-blue-800 mb-1">üí∞ Bruto: R$ ${bruto.toLocaleString('pt-BR')}</div>
          <div class="text-xl font-semibold text-green-600 mb-1">üîª L√≠quido: R$ ${liquido.toLocaleString('pt-BR')}</div>
          <div class="text-base text-gray-600 mb-4">üõí Vendas: ${qtd}</div>

          <div class="flex justify-between items-center mt-4">
            <button onclick='mostrarDetalhesFaturamento("${docData.id}")'
              class="btn btn-outline">
              <i class="fas fa-search"></i> Ver Detalhes
            </button>
            <button onclick='excluirFaturamento("${docData.id}")'
              class="btn btn-outline">
              <i class="fas fa-trash-alt"></i> Excluir
            </button>
          </div>

          <div id="detalhes-${docData.id}" class="mt-3 text-sm text-gray-700" style="display:none;"></div>
        `;

        container.appendChild(card);
      }
    }

    async function mostrarDetalhesFaturamento(dataRef) {
      const detalhesEl = document.getElementById("detalhes-" + dataRef);
      if (detalhesEl.style.display === "block") {
        detalhesEl.style.display = "none";
        return;
      }

      detalhesEl.innerHTML = `<div class="text-sm text-gray-500">üîÑ Carregando...</div>`;
      detalhesEl.style.display = "block";

 let ref = db.collection("faturamento").doc(dataRef).collection("lojas");
      if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
        ref = ref.where('uid', '==', usuarioLogado.uid);
      }
      const snap = await ref.get();
      const { decryptString } = await import('./crypto.js');

      let html = "";
     for (const doc of snap.docs) {
        let d = doc.data();
        if (d.encrypted) {
          try {
            const txt = await decryptString(d.encrypted, getPassphrase() || usuarioLogado.uid);
            d = JSON.parse(txt);
          } catch (e) { console.error('Erro ao descriptografar faturamento', e); }
        }
        const loja = d.loja || "Desconhecida";
        const bruto = d.valorBruto?.toLocaleString("pt-BR") || "0,00";
        const liquido = d.valorLiquido?.toLocaleString("pt-BR") || "0,00";
        const vendas = d.qtdVendas || 0;

        html += `
          <div class="mt-1 text-sm text-gray-800 border-t pt-1">
            <strong>${loja}</strong>: Bruto R$ ${bruto} | L√≠quido R$ ${liquido} | Vendas: ${vendas}
          </div>
        `;
     }

      detalhesEl.innerHTML = html;
    }

    async function excluirFaturamento(data) {
      if (!confirm(`Tem certeza que deseja excluir o faturamento do dia ${data}?`)) return;
      await db.collection("faturamento").doc(data).delete();
      mostrarSucesso("Registro exclu√≠do com sucesso.");
      carregarRegistrosFaturamento();
    }

    function exportarJSON() {
      if (pedidosProcessados.length === 0) {
        mostrarErro('Nenhum dado dispon√≠vel para exportar. Processe um arquivo primeiro.');
        return;
      }
      
      try {
        const data = {
          geradoEm: new Date().toISOString(),
          pedidos: pedidosProcessados,
          resumo: {
            totalSobra: pedidosProcessados.reduce((sum, p) => sum + p.sobra, 0),
            totalMeta: pedidosProcessados.reduce((sum, p) => sum + (p.meta || 0), 0)
          }
        };
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
        saveAs(blob, `relatorio_sobras_${new Date().toISOString().slice(0,10)}.json`);
        
        mostrarSucesso('Arquivo JSON exportado com sucesso!');
      } catch (error) {
        mostrarErro(`Erro ao exportar JSON: ${error.message}`);
        console.error("Erro ao exportar JSON:", error);
      }
    }
    async function analisarSobrasComIA() {
      try {
        const linhas = document.querySelectorAll("#tabelaSobras tbody tr");
        let dados = [];

        linhas.forEach(linha => {
          const colunas = linha.querySelectorAll("td");
          if (colunas.length >= 5) {
            dados.push({
              sku: colunas[0].innerText.trim(),
              nome: colunas[1].innerText.trim(),
              vendido: parseInt(colunas[2].innerText) || 0,
              sobra: parseInt(colunas[3].innerText) || 0,
              data: colunas[4].innerText.trim()
            });
          }
        });

        const prompt = `
    Voc√™ √© um especialista em controle de estoque e sobras da Shopee.

    Receber√° uma lista com SKUs, nomes, vendidos e sobras.

    Analise:
    üîπ 1. Valide se a sobra registrada faz sentido
    üîπ 2. Detecte padr√µes incomuns (ex: sobra alta sem venda)
    üîπ 3. Gere resumo por SKU com observa√ß√µes
    üîπ 4. Sugira a√ß√µes (ex: revisar, repor, ignorar)

    Dados:
    ${JSON.stringify(dados, null, 2)}
    `;

        const resposta = await consultarDeepSeek(prompt);
        document.getElementById("resultadoIA").innerText = resposta;
      } catch (erro) {
        console.error("Erro IA sobras:", erro);
        document.getElementById("resultadoIA").innerText = "Erro ao analisar sobras com IA.";
      }
    }
    async function analisarSobrasIA() {
      const prompt = `
    Sou um sistema de controle de sobras da Shopee. Com base nos dados abaixo, analise se os SKUs est√£o performando bem, identifique padr√µes incomuns e sugira a√ß√µes como promo√ß√µes, reposi√ß√£o ou aten√ß√£o especial.

    Dados:
    ${document.getElementById("dadosSobrasIA").value}

    Gere um resumo inteligente com insights pr√°ticos.
    `;

      document.getElementById("resultadoIA").innerHTML = "‚åõ Analisando com IA...";
      
      try {
        const resposta = await fetch("https://us-central1-matheus-35023.cloudfunctions.net/proxyDeepSeek", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pergunta: prompt })
        });

        const data = await resposta.json();
        const output = data.choices?.[0]?.message?.content || data.resposta || "‚ö†Ô∏è Resposta n√£o recebida.";

        document.getElementById("resultadoIA").innerHTML = output;
      } catch (error) {
        document.getElementById("resultadoIA").innerHTML = "‚ùå Erro ao consultar IA: " + error.message;
        console.error("Erro IA:", error);
      }
    }
    async function carregarControleVendas() {
      const container = document.getElementById("listaControleVendas");
      const filtroMes = document.getElementById("filtroMesVendas")?.value;
      container.innerHTML = "üîÑ Carregando...";

      const ref = db.collection("skusVendidos");
      const snap = await ref.get();

      container.innerHTML = "";

      for (const doc of snap.docs) {
        const dataDoc = doc.id; // Ex: 2025-07-21
        if (filtroMes) {
          const [anoFiltro, mesFiltro] = filtroMes.split("-");
          const [anoDoc, mesDoc] = dataDoc.split("-");
          if (anoFiltro !== anoDoc || mesFiltro !== mesDoc) continue;
        }

 let listaRef = db.collection(`skusVendidos/${dataDoc}/lista`);
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          listaRef = listaRef.where('uid', '==', usuarioLogado.uid);
        }
        const listaSnap = await listaRef.get();
        if (listaSnap.empty) continue;

        let htmlSKUs = "";
        let totalDia = 0;

        listaSnap.forEach(docSKU => {
          const { sku, total, loja } = docSKU.data();
          totalDia += total || 0;
          htmlSKUs += `
      <div class="text-sm text-gray-700">
        <strong>${sku || docSKU.id}</strong> (${loja || "-"}) ‚Äî ${total || 0} unid.
      </div>`;
        });

        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4 border border-gray-200";
        card.innerHTML = `
          <div class="text-center font-bold bg-blue-100 text-blue-800 py-2 rounded mb-2">${dataDoc}</div>
          <div class="mb-2 text-sm text-gray-600">üßæ Total do dia: <strong>${totalDia}</strong> unidades</div>
          ${htmlSKUs}
          <div class="text-right mt-2">
        <button onclick="verDetalhesDia('${dataDoc}')" class="text-blue-600 text-sm underline">üîç Ver mais</button>
      </div>
        `;
        container.appendChild(card);
      }

      if (container.innerHTML === "") {
        container.innerHTML = `<p class="text-gray-500">Nenhum dado encontrado para o per√≠odo selecionado.</p>`;
      }
    }
    window.verDetalhesDia = async function (dataDoc) {
 let ref = db.collection(`skusVendidos/${dataDoc}/lista`);
      if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
        ref = ref.where('uid', '==', usuarioLogado.uid);
      }
      const snap = await ref.get();

      const agrupadoPorLoja = {};
      let sobraEsperada = 0;

      for (const doc of snap.docs) {
        const { sku, total, loja } = doc.data();
        if (!agrupadoPorLoja[loja]) agrupadoPorLoja[loja] = [];
        agrupadoPorLoja[loja].push({ sku, total });

        // üîç Buscar CUSTO do SKU na cole√ß√£o "products"
        try {
          const produtosRef = db.collection("products");
          const querySnap = await produtosRef.where("sku", "==", sku).limit(1).get();
          if (!querySnap.empty) {
            const dados = querySnap.docs[0].data();
            const custo = Number(dados.custo || 0);
            sobraEsperada += (total || 0) * custo;
          }
        } catch (e) {
          console.warn(`Erro ao buscar custo do SKU ${sku}:`, e);
        }
      }

      // üîç Somar valor l√≠quido de todas as lojas do dia
      let valorLiquido = 0;
      try {
 let lojasRef = db.collection(`faturamento/${dataDoc}/lojas`);
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          lojasRef = lojasRef.where('uid', '==', usuarioLogado.uid);
        }
        const lojasSnap = await lojasRef.get();
          const { decryptString } = await import('./crypto.js');
        for (const lojaDoc of lojasSnap.docs) {
          let dados = lojaDoc.data();
          if (dados.encrypted) {
            try {
              const txt = await decryptString(dados.encrypted, getPassphrase() || usuarioLogado.uid);
              dados = JSON.parse(txt);
            } catch (e) { console.error('Erro ao descriptografar faturamento', e); }
          }
          valorLiquido += Number(dados.valorLiquido || 0);
           }
      } catch (e) {
        console.warn("Erro ao buscar valor l√≠quido por loja:", e);
      }

      // üßæ Montar HTML
      let html = `<strong>üìÖ Detalhes de ${dataDoc}</strong><br><br>`;
      for (const loja in agrupadoPorLoja) {
        html += `<strong>üè™ Loja: ${loja}</strong><br>`;
        agrupadoPorLoja[loja].forEach(({ sku, total }) => {
          html += `‚Ä¢ ${sku}: ${total} unid.<br>`;
        });
        html += `<br>`;
      }

      html += `<hr><strong>üì¶ Sobra Esperada:</strong> R$ ${sobraEsperada.toFixed(2)}<br>`;
      html += `<strong>üí∞ Valor L√≠quido Real:</strong> R$ ${valorLiquido.toFixed(2)}<br>`;

      Swal.fire({
        title: 'Detalhamento por Loja',
        html: html,
        icon: 'info',
        confirmButtonText: 'Fechar'
      });
    };

    async function exportarFaturamentoExcel() {
let ref = db.collection("faturamento");
      if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
        ref = ref.where('uid', '==', usuarioLogado.uid);
      }
      const snap = await ref.get();
      const { decryptString } = await import('./crypto.js');

      for (const docData of snap.docs) {
 let subRef = db.collection(`faturamento/${docData.id}/lojas`);
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          subRef = subRef.where('uid', '==', usuarioLogado.uid);
        }
        const subSnap = await subRef.get();
       for (const sub of subSnap.docs) {
          let d = sub.data();
          if (d.encrypted) {
            try {
              const txt = await decryptString(d.encrypted, getPassphrase() || usuarioLogado.uid);
              d = JSON.parse(txt);
            } catch (e) { console.error('Erro ao descriptografar faturamento', e); }
          }
          dataExport.push({
            Data: docData.id,
            Loja: d.loja || "Desconhecida",
            Bruto: d.valorBruto || 0,
            Taxas: d.taxasPlataforma || 0,
            L√≠quido: d.valorLiquido || 0,
            Vendas: d.qtdVendas || 0
          });
       }
      }

      if (dataExport.length === 0) {
        alert("Nenhum dado de faturamento encontrado.");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(dataExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Faturamento");
      XLSX.writeFile(wb, "faturamento.xlsx");
    }
    
    async function carregarAcompanhamento() {
      const tbody = document.querySelector('#tabelaAcompanhamento tbody');
      const resumoEl = document.getElementById('resumoAcompanhamento');
      tbody.innerHTML = '<tr><td colspan="4">üîÑ Carregando...</td></tr>';
      resumoEl.innerHTML = '';

      let ref = db.collection('faturamento');
      if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
        ref = ref.where('uid', '==', usuarioLogado.uid);
      }
      const snap = await ref.get();

      const filtroMes = document.getElementById('filtroMesAcompanhamento')?.value;
      let dados = [];
            dadosAcompanhamento = [];
      let totalBruto = 0, totalLiquido = 0, totalVendas = 0, totalSobra = 0;

      for (const doc of snap.docs) {
        if (filtroMes) {
          const [anoFiltro, mesFiltro] = filtroMes.split('-');
          const [ano, mes] = doc.id.split('-');
          if (ano !== anoFiltro || mes !== mesFiltro) continue;
        }

        let subRef = db.collection(`faturamento/${doc.id}/lojas`);
        if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
          subRef = subRef.where('uid', '==', usuarioLogado.uid);
        }
        const subSnap = await subRef.get();
                const { decryptString } = await import('./crypto.js');
        let bruto = 0, liquido = 0, vendas = 0;
         for (const s of subSnap.docs) {
          let d = s.data();
          if (d.encrypted) {
            try {
              const txt = await decryptString(d.encrypted, getPassphrase() || usuarioLogado.uid);
              d = JSON.parse(txt);
            } catch (e) { console.error('Erro ao descriptografar faturamento', e); }
          }
          bruto += d.valorBruto || 0;
          liquido += d.valorLiquido || 0;
          vendas += d.qtdVendas || 0;
        }

        let sobraDia = 0;
        try {
          let listaRef = db.collection(`skusVendidos/${doc.id}/lista`);
          if (usuarioLogado.perfil.toLowerCase() !== 'adm') {
            listaRef = listaRef.where('uid', '==', usuarioLogado.uid);
          }
          const listaSnap = await listaRef.get();
          listaSnap.forEach(item => {
            const { sku, total } = item.data();
            const custo = Number(produtos[sku] || 0);
            sobraDia += (total || 0) * custo;
          });
        } catch (e) {
          console.warn('Erro ao calcular sobra esperada do dia', e);
        }

        dados.push({ data: doc.id, bruto, liquido, vendas, sobra: sobraDia });
        totalBruto += bruto;
        totalLiquido += liquido;
        totalVendas += vendas;
        totalSobra += sobraDia;
      }

      tbody.innerHTML = '';
      dados.sort((a,b) => a.data.localeCompare(b.data));
      dadosAcompanhamento = dados.slice();
      dados.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.data}</td><td>R$ ${d.bruto.toLocaleString('pt-BR')}</td><td>R$ ${d.liquido.toLocaleString('pt-BR')}</td><td>${d.vendas}</td>`;
        tbody.appendChild(tr);
      });

 // Calcula totais a partir de dadosAcompanhamento
      const totais = dadosAcompanhamento.reduce((acc, item) => {
        acc.bruto += item.bruto || 0;
        acc.liquido += item.liquido || 0;
        acc.vendas += item.vendas || 0;
        acc.sobra += item.sobra || 0;
        return acc;
      }, { bruto: 0, liquido: 0, vendas: 0, sobra: 0 });
      const ticket = totais.vendas ? totais.liquido / totais.vendas : 0;

      resumoEl.classList.add('resumo-grid');
      resumoEl.innerHTML = `
        <div class="resumo-card"><h4>Total Bruto</h4><p>R$ ${totais.bruto.toLocaleString('pt-BR')}</p></div>
        <div class="resumo-card"><h4>Total L√≠quido</h4><p>R$ ${totais.liquido.toLocaleString('pt-BR')}</p></div>
        <div class="resumo-card"><h4>Total Vendido</h4><p>${totais.vendas}</p></div>
        <div class="resumo-card"><h4>Total Sobra Esperada</h4><p>R$ ${totais.sobra.toLocaleString('pt-BR')}</p></div>
        <div class="resumo-card"><h4>Ticket M√©dio</h4><p>R$ ${ticket.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p></div>`;
    }

     function exportarAcompanhamentoExcel() {
      if (!dadosAcompanhamento.length) return;
      const ws = XLSX.utils.json_to_sheet(dadosAcompanhamento);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Acompanhamento');
      XLSX.writeFile(wb, 'acompanhamento.xlsx');
    }

    function exportarAcompanhamentoPDF() {
      const element = document.getElementById('areaImpressao');
      if (!element) return;
      const opt = { margin: 1, filename: 'acompanhamento.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } };
      html2pdf().set(opt).from(element).save();
    }

    function printAcompanhamento() {
 const element = document.getElementById('areaImpressao');
      if (!element) return;
      const printWindow = window.open('', '', 'width=900,height=650');
      printWindow.document.write(`
        <html>
          <head>
            <title>Imprimir Acompanhamento</title>
            <link rel="stylesheet" href="css/styles.css">
            <link rel="stylesheet" href="css/components.css">
          </head>
          <body>
            ${element.innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }
function aplicarEstiloCritico() {
  const linhas = document.querySelectorAll("#resultado tbody tr");

  linhas.forEach(linha => {
    const statusEl = linha.querySelector(".status-only");
    if (!statusEl) return;

    const status = statusEl.textContent.trim().toLowerCase();

    if (status === "cr√≠tico") {
      linha.style.backgroundColor = "#ffebee"; // fundo vermelho claro
      linha.style.color = "#b71c1c";            // texto vermelho escuro
      linha.style.fontWeight = "bold";
    } else {
      // Remove estilo se n√£o for cr√≠tico (√∫til em reaplica√ß√µes de filtro)
      linha.style.backgroundColor = "";
      linha.style.color = "";
      linha.style.fontWeight = "";
    }
  });
}
 window.toggleInfoFaturamento = function() {
    const card = document.getElementById('infoFaturamento');
    if (card) {
      card.classList.toggle('hidden');
    }
  };


function filtrarPorSKU() {
  const tipoFiltro = document.getElementById('tipoFiltro').value;
  const textoSKU = document.getElementById('filtroSKU').value.trim().toLowerCase();
  const filtroStatus = document.getElementById('filtroStatus').value.toLowerCase();

  const linhas = document.querySelectorAll("#resultado tbody tr");

  linhas.forEach(linha => {
    const sku = linha.children[1].textContent.toLowerCase();
    const status = linha.children[9].textContent.trim().toLowerCase();

    let corresponde = false;

    if (textoSKU === '') {
      corresponde = true;
    } else if (tipoFiltro === 'exata') {
      corresponde = sku === textoSKU;
    } else if (tipoFiltro === 'comeca') {
      corresponde = sku.startsWith(textoSKU);
    } else {
      corresponde = sku.includes(textoSKU);
    }

    const statusCorresponde = !filtroStatus || status === filtroStatus;

    linha.style.display = corresponde && statusCorresponde ? '' : 'none';
  });
}

</script>
<script src="shared.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get('tab') || (window.location.hash ? window.location.hash.substring(1) : null);
    if (initialTab && document.getElementById(initialTab)) {
      trocarAba(initialTab);
    }
  });
</script>

<!-- Outras bibliotecas (como XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

</body>
</html>
